<!DOCTYPE HTML>
<!-- vim:filetype=html:textwidth=200:shiftwidth=4:softtabstop=4:expandtab
-->
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <title>Limited reasoner demo</title>

    <!-- <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"> -->
    <style type="text/css">
        body { font-family: 'Open Sans', sans-serif; font-size: 140%; }
        p { text-align: justify; }

        h1       { font-size: 220%; }
        h2       { font-size: 170%; border-bottom: 1px solid #aaa; }

        form input.number { width: 5em; }
        #play-button { background-color: black; color: #eee; font-family: inherit; font-weight: bold; font-size: 100%; margin-top: 1ex; margin-left: 1em; padding-left: 3em; padding-right: 3em; padding-top: 1ex; padding-bottom: 1ex; }
        #play-button {
            background:
                linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px,
                linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px,
                linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px,
                linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px,
                linear-gradient(90deg, #1b1b1b 10px, transparent 10px),
                linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);
            background-color: #131313;
            background-size: 20px 20px;
        }

        #output #messages { }
        div.table { display: table; overflow: scroll; border-collapse: collapse; }
        div.table div.row { display: table-row; }
        div.table div.row div.header,
        div.table div.row div.cell { display: table-cell; width: 2em; min-width: 2em; height: 2em; text-align: center; vertical-align: middle; padding: 0; margin: 0; overflow: hidden; }
        div.table div.row div.header { background-color: #cecece; }
        div.table div.row div.cell { border: 1px solid black; }
        div.table div.row div.cell.new { font-weight: bold; }
        div.table div.row div.cell.mistake { background-color: red; font-weight: bold; }
        div.table div.row div.cell.real { background-color: orange; font-weight: bold; }
        div.table div.row div.cell:empty { background-color: #efefef; }

        #output span { }
        #output span.black { color: black; }
        #output span.dim { color: #999; }
        #output span.reset { color: inherit; }
        #output span.red { color: red; font-weight: bold; }
        #output span.green { color: green; font-weight: bold; }
    </style>

    <script src="jquery-3.1.1.min.js"></script>
    <script src="mw-js.js"></script>
</head>

<body>

<h1>Limited Reasoner Demo: Minesweeper</h1>

<p>
<b>Quick start:</b> hit the "Click me to play Minesweeper!" button and see the agent play under "Game Output".
</p>

<p>
For further demos and details on the reasoner, <a href="../">click here</a>.
</p>

<h2>Game Configuration</h2>

<p>Standard configurations:
        <a id="config-small" href="#config-small">small</a>,
        <a id="config-medium" href="#config-medium">medium</a>,
        <a id="config-large" href="#config-large">large</a>,
        <a id="config-huge" href="#config-huge">huge</a>
</p>

<form>
<div style="display: table;">
<div style="display: table-row;"><div style="display: table-cell;">Field width:</div><div style="display: table-cell;"><input type="number" id="width" min="0" class="number"></div></div>
<div style="display: table-row;"><div style="display: table-cell;">Field height:</div><div style="display: table-cell;"><input type="number" id="height" min="0" class="number"></div></div>
<div style="display: table-row;"><div style="display: table-cell;">Number of mines:</div><div style="display: table-cell;"><input type="number" id="n_mines" min="0" class="number"></div></div>
<div style="display: table-row; height: 1ex;"></div>
<div style="display: table-row;"><div style="display: table-cell; padding-right: 1ex;">Max. number of case splits:</div><div style="display: table-cell;"><input type="number" id="max_k" min="0" value="2" class="number"></div></div>
<div style="display: table-row;"><div style="display: table-cell;">Mine placement seed:</div><div style="display: table-cell;"><input type="number" id="seed" min="0" value="1" class="number"> (modify for different mine placement)</div></div>
</div>
<input id="play-button" type="button" value="Click me to play Minesweeper!" />
</form>

<script>
$(document).ready(function() {
    $('#config-small').click(function() { setConfig(8, 8, 10); return false; }).click();
    $('#config-medium').click(function() { setConfig(16, 16, 40); return false; });
    $('#config-large').click(function() { setConfig(30, 16, 99); return false; });
    $('#config-huge').click(function() { setConfig(64, 32, 320); return false; });
    $('#play-button').click(function() { play(); }).focus();
    $('#width').change(function() { initDisplay(); });
    $('#height').change(function() { initDisplay(); });
    $('#different-seed').click(function() { $('#seed').val(parseInt($('#seed').val()) + 1); scrollToShow('#play-button'); return false; });
    $('#different-field-size').click(function() { scrollToShow('#config-small'); return false; });
    $('#different-seed-msg').hide();
    initDisplay();
});

function setConfig(width, height, n_mines) {
    document.getElementById('width').value = width;
    document.getElementById('height').value = height;
    document.getElementById('n_mines').value = n_mines;
    initDisplay();
}

var timerOverall = 0;
var timerTurn = null;

function play() {
    var width = document.getElementById('width').value;
    if (width == null) width = 8;
    var height = document.getElementById('height').value;
    if (height == null) height = 8;
    var n_mines = document.getElementById('n_mines').value;
    if (n_mines == null) n_mines = 10;
    var seed = document.getElementById('seed').value;
    if (seed == null) n_mines = 0;
    var max_k = document.getElementById('max_k').value;
    if (max_k == null) max_k = 0;

    initDisplay();
    timerOverall = 0;
    scrollToShow('#output');
    Module.ccall('lela_init', 'void', ['number', 'number', 'number', 'number', 'number'], [width, height, n_mines, seed, max_k]);
    playTurn();
}

function playTurn() {
    setTimeout(function() {
        var t0 = performance.now();
        timerTurn = t0;
        var gameOver = Module.ccall('lela_play_turn', 'number', [], []);
        var t1 = performance.now();
        timerOverall += t1 - t0;
        if (!gameOver) {
            playTurn();
        }
    }, 0);
}

function cellId(x, y) {
    return 'cell_'+ x +'_'+ y;
}

var width = -1;
var height = -1;
var games = [];
var messages = [];
var currentGame = -1;
var currentMessage = -1;
var gameOver = false;

function cell(x, y) {
    return $('#'+ cellId(x, y));
}

function initDisplay() {
    width = document.getElementById('width').value;
    if (width == null) width = 8;
    height = document.getElementById('height').value;
    if (height == null) height = 8;

    var output = $('#output');
    output.empty();
    games = [];
    messages = [];
    currentGame = -1;
    currentMessage = -1;
    gameOver = false;

    output.append('<div class="table"></div>');
    var table = $('#output').children().last();
    {
        table.append('<div class="row"></div>');
        var row = table.children().last();
        row.append('<div class="header"></div>');
        var x;
        for (x = 0; x < width; ++x) {
            row.append('<div class="header">'+ (x+1) +'</div>');
        }
    }
    var y;
    for (y = 0; y < height; ++y) {
        table.append('<div class="row"></div>');
        var row = table.children().last();
        row.append('<div class="header">'+ (y+1) +'</div>');
        var x;
        for (x = 0; x < width; ++x) {
            row.append('<div id="'+ cellId(x, y) +'" class="cell"></div>');
        }
    }
}

function updateMessage(arg1, arg2, arg3, arg4) {
    var t1 = performance.now();
    var tDiff = t1 - timerTurn;
    if (typeof arg1 === 'string') {
        messages.push(arg1);
        currentMessage = messages.length - 1;
        if (games.length + 1 != messages.length) {
            console.log('games and messages out of sync '+ (games.length + 1) +' != '+ messages.length);
        }
    } else if (typeof arg1 === 'number' && typeof arg2 === 'number' && typeof arg3 === 'number' && typeof arg4 === 'number') {
        var exploration = arg1 == 0;
        var x = arg2;
        var y = arg3;
        var k = arg4;
        var msg = (exploration ? 'Exploring' : 'Flagging') +' ('+ (x+1) +' | '+ (y+1) +'), '+ (k == -1 ? 'which is just a guess after' : 'found at split level '+ k +' found in') +' '+ Math.ceil(tDiff)/1000 +'&nbsp;seconds.';
        messages.push(msg);
        currentMessage = messages.length - 1;
    }
    var msg = messages[currentMessage];
    if (gameOver && currentMessage == messages.length - 1) {
        $('#messages').html(msg);
        $('#different-seed-msg').show();
    } else {
        $('#messages').html(msg);
        $('#different-seed-msg').hide();
    }
}

function updateMessageGameOver() {
    gameOver = true;
    var msg;
    if (games[currentGame].indexOf(' ') == -1) {
        msg = '<div style="display: inline; color: green; font-weight: bold;">We won &#9786;</div> <div style="display: inline; padding-left: 1ex;">It took '+ Math.ceil(timerOverall)/1000 +'&nbsp;seconds.</div>';
    } else {
        msg = '<div style="display: inline; color: red; font-weight: bold;">We hit a mine &#9785;</div> <div style="display: inline; padding-left: 1ex;">It took '+ Math.ceil(timerOverall)/1000 +'&nbsp;seconds.</div>';
    }
    updateMessage(msg);
}

function displayGame(arg) {
    if (typeof arg === 'string') {
        games.push(arg);
        currentGame = games.length - 1;
    }
    if (games.length != messages.length) {
        console.log('games and messages out of sync '+ games.length +' != '+ messages.length);
    }
    var lastLegal = currentGame > 1 ? games[currentGame - 2] : null;
    var lastMove = currentGame > 0 ? games[currentGame - 1] : null;
    var g = games[currentGame];
    var gameOverAndFinalDisplay = gameOver && currentGame == games.length - 1;
    var didMistake = gameOverAndFinalDisplay && lastMove != g;
    var i;
    for (i = 0; i < g.length; ++i) {
        var c = g[i];
        if (c == ' ') { c = "" }
        if (c == '.') { c = "&middot;" }
        var x = i % width;
        var y = Math.floor(i / width);
        var e = cell(x, y);
        e.html(c);
        e.removeClass('new');
        e.removeClass('mistake');
        e.removeClass('real');
        if (gameOverAndFinalDisplay) {
            if (lastLegal != null && lastLegal[i] != lastMove[i] && didMistake) {
                e.addClass('new');
                e.addClass('mistake');
            } else if (lastMove != null && lastMove[i] != g[i]) {
                e.addClass('new');
                e.addClass('real');
            }
        } else {
            if (lastMove != null && lastMove[i] != g[i]) {
                e.addClass('new');
            }
        }
    }
}

function scrollToShow(e) {
    var currentTop = $(document).scrollTop();
    var currentBottom = $(document).scrollTop() + $(window).height();
    var goalTop = $(e).offset().top;
    var goalBottom = $(e).offset().top + $(e).outerHeight();
    var inDisplay = function(pos) { return currentTop <= pos && pos <= currentBottom; };
    var topOfScreen = function(pos) { return pos < currentTop; };
    var belowOfScreen = function(pos) { return pos > currentBottom; };
    var fitsIntoScreen = $(e).outerHeight() <= $(window).height();
    var goal;
    var timeout = 200;
    if (inDisplay(goalTop) && inDisplay(goalBottom)) {
        // No need to scroll.
    } else if (!inDisplay(goalTop) && belowOfScreen(goalTop) && fitsIntoScreen) {
        // Scroll so that bottom of element aligns with bottom of window.
        $('html, body').animate({ scrollTop: goalBottom - $(window).height() }, timeout);
    } else if (!inDisplay(goalTop)) {
        // Scroll so that top of element aligns with top of window.
        $('html, body').animate({ scrollTop: goalTop }, timeout);
    } else if (!inDisplay(goalBottom)) {
        // Scroll so that bottom of element aligns with bottom of window.
        $('html, body').animate({ scrollTop: goalBottom - $(window).height() }, timeout);
    }
}

function showMove(i) {
    currentGame    = i;
    currentMessage = i;
    if (currentGame    < 0) currentGame = 0;
    if (currentMessage < 0) currentMessage = 0;
    if (currentGame    >= games.length) currentGame = games.length - 1;
    if (currentMessage >= messages.length) currentMessage = messages.length - 1;
    displayGame();
    updateMessage();
}

$(document).ready(function() {
    $('#field-prev').click(function() { showMove(currentGame - 1); return false; });
    $('#field-next').click(function() { showMove(currentGame + 1); return false; });
});
$(document).keydown(function(e) {
    switch(e.which) {
        case 37: showMove(currentGame - 1); break; // left
        case 39: showMove(currentGame + 1); break; // right
        default: return;
    }
    e.preventDefault();
});
</script>



<h2>Game Output</h2>

<p>
<div id="messages" style="display: inline;">Ready to play!</div>
<div id="different-seed-msg" style="padding-left: 1ex; display: inline;">Would you like to try again? Change the <a id="different-seed" href="#">mine placement seed</a> or the <a id="different-field-size" href="#">field size</a>!</div>
</p>

<div id="output"></div>

<p>
<b>Quick explanation:</b>
The agent aims to explore the field without hitting a mine.
When it opens a mine-free cell, it learns how many adjacent cells contain a mine.
This number is displayed in every cell (except for <code>0</code>, which instead is visualised by a dot).
A green <code style="color: green; font-weight: bold;">X</code> represents a cell the agent has reasoned out to contain a mine.
</p>

<p>See <a href="#field-prev" id="field-prev">previous</a> / <a href="#field-next" id="field-next">next</a> turn (or use arrow keys &#x21e6; &#x21e8;).



<h2>About Minesweeper</h2>

<p>
Among the <code>width</code> &times; <code>height</code> cells on the field, <code>n_mines</code> cells contain a mine. The goal of the agent is to identify these mines.
</p>

<p>
On every turn, the player selects a cell and either explores it or flags it as mine.
Exploring a cell tells the agent how many adjacent cells (0 &le; N &le; 8) contain mines.
(When N = 0, the adjacent cells are explored immediately.)
Flagging a cell does not tell the agent anything, it's more of a mental note not to explore the cell.
Explored fields are visualized as their number <code>N</code> or by a <code>.</code> symbol when N = 0; flagged cells are marked by a <code style="color: green; font-weight: bold;">X</code> symbol.
</p>

<p>
The game is won when all non-mine fields are explored and all mine cells are flagged. The game is lost when the agent explores a mine cell.
</p>



<h2>About the Agent</h2>

<p>
The agent is a simple C++ program that loops over all cells and uses the reasoner to find out which cells are known to contain a/no mine.
</p>

<p>
For every cell <code>(x,y)</code>, we use a proposition <code>IsMine(x,y)</code>.
When a cell is explored, the agent receives the information how many adjacent cells contain a mine.
To reflect this new information, the agent adds clauses of <code>IsMine(x,y)</code>.
For instance, when the agent learns that one of the eight adjacent cell contains a mine, it adds <code>IsMine(x-1,y) &or; IsMine(x-1,y+1) &or; IsMine(x,y+1) &or; IsMine(x+1,y+1) &or; IsMine(x+1,y) &or; IsMine(x+1,y-1) &or; IsMine(x,y-1) &or; IsMine(x-1,y-1)</code> to say that at least one of the neighbours contains a mine, and a few similar clauses to say that at least seven adjacent cells contain <i>no</i> mine.
</p>

<p>
On every turn, the agent checks for every cell whether it is known to contain a mine or known to contain no mine.
(As a simple heuristic, the agent starts with cells in the neighbourhood of the cell selected in the last move.)
This process is repeated for increasing split level, until a cell which is known to be a mine or known to be safe is found: first for split level 0, then for 1, ..., until the maximum specified split level.
If no cell is found, the agent guesses one randomly.
</p>

<p>
Note the agent's actions are not represented in the knowledge base&mdash;it's just hard-coded in C++.
Extending the knowledge base to a basic action theory that also represents the agent's actions would be the next step.
</p>

<p>
The runtime reported by the game refers to the time the agent actually spend playing.
The actual time that passes between starting and finishing the game may be longer because the graphical display procedures take some time.
</p>

</body>
</html>

